---
author: "Ramon Puig, Jordi Real"
website: "https://github.com/USR-DAPCAT/"
date: "`r format(Sys.time(), '%d %B, %Y')`"

output:
 html_document:
   df_print: paged
   toc: true
   toc_float: true
   fig_caption: true
   css: logos_css/usr_styles.css
   pdf_document: default
   word_document: default

params:
  metode: "dinamica2"  # "dinamica" / "dinamica2" / "estatica" / "PS" 
  subtitul: ""
  test: FALSE

title: "Diabetes y Tuberculosis en Ciutat Vella (Barcelona). Estudio longitudinal de la asociación de las dos enfermedades en un distrito con alta prevalencia de tuberculosis"
subtitle: "`r params$subtitul`"

---
  
  
&nbsp;
<script>
  $(document).ready(function() {
    $head = $('#header');
    $head.prepend('<img src=\"https://www.idiapjgol.org/images/logo.png\" style=\"float: right ;width: 130px;\"/>')
    $head.prepend('<img src=\"https://avatars2.githubusercontent.com/u/57066591?s=200&v=4\" style=\"margin-left:25% ;width: 80px;\"/>')
    $head.prepend('<img src=\"logos_css/logoDAP_Cat.png\" style=\"float: left:1;width: 185px;\"/>')
  });
</script>
  
  
  <div class="watermark">DRAFT</div>
  
  ****
  
  # Objectivos
  
  ## Objetivo principal
  
  - Analizar la relación epidemiológica y los factores asociados entre la DM y la TB en un distrito de elevada prevalencia de TB (Ciutat Vella de Barcelona).
- Conocer el riesgo de TB entre la población con DM en un distrito de elevada prevalencia de TB (Ciutat Vella de Barcelona) para identificar subgrupos de alto riesgo y potencialmente susceptibles de cribado de TB.


## Objetivos secundarios 

- 1.  Comparar la evolución de la prevalencia de la DM y de la TB en el periodo 2006 al 2015 en el distrito de Ciutat Vella, un entorno de alta prevalencia de TB.
- 2.	Conocer la prevalencia y la incidencia de TB entre la población con DM con respecto a la población no diabética.
- 3.	Analizar si el grado de control metabólico de la DM influye en la forma de TB (pulmonar o extrapulmonar), la gravedad y la respuesta al tratamiento.
- 4.	Analizar el papel de la inmigración en la relación entre DM y TB.

-----
  
  
  ## Actualizaciones 
  
  >04/03/2022
  
&check; Características basales de las variables de estudio entre diabéticos con y sin TB <br/>
  
  
  >16/9/2020
  
&check; Agregar variable tabaquismo en base a diagnóstico <br/>
&check; Generar variable cualquier vacuna <br/>
  
  
  >09/2020
  
&check; Nueva variable Tratamiento antidiabético <br/>
&check; Descriptiva comparativa de eventos TVC del subestudio de DM vs no DM <br/>

>22-30/06/2020

&check; Recategoritzación de grupos de paises a) España+Paises Ricos, b) India, pakistan , c) Resto, d) None) <br/>
&check; En Cohorte dinámica, truncamiento de seguimiento cuando cambia de grupo <br/>
&check; Realizar los truncamientos en la cohorte dinámica <br/>
&check; Descriptivo general de todos los casos de TBC ya sean antencedentes o eventos de la base de datos de la Agencia <br/>
&check; Capturar histórico HBA1c.valor <br/>
&check; Generación de variables HBA1c.valor en ultima fecha (dt_libre_TBC: fecha de TBC o Última fecha de seguimiento) <br/>
&check; Comparativa de medias último valor HBA1c entre TBC's y no TBC's  <br/>


## Hecho: 

 >08/06/2020
 
&check; Reprogramación cohorte dinámica (Controles sin reemplazo / Casos Reutilizados) <br/>
&check; Categorización de países <br/>
&check; Actualización de resultados <br/>

>15/05/2020

&check; Depuración: Reclasificación de controles a diabéticos según histórico de fármacos antidiabéticos y fecha de inclusión (Mínima)<br/>
&check; Depuración: Recalculo de edad sólo basado en CIP <br/>
&check; Depuración: Reconsiderar evento TBC sólo aquellos con información en BD ASPB <br/>
&check; Depuración: Detectado y eliminados sujetos por edad (Nacidos post inclusión) <br/>
&check; Incluir sujetos con antecedentes TBC <br/>
&check; Agrupación de países por áreas <br/>
&check; Análisis de sensibilidad con eventos ASPB <br/>
&check; + Modelos <br/>
&check; Descriptivo de eventos de TBC <br/>
&check; Descriptivo de datos ASPB <br/>
&check; Reanálisis completo <br/>
&check; Actualizado evento TBC con fecha de tratamiento / fecha notificación (primera entre ambas) / o DET_TB según E-CAP en caso contrario <br/>
&check; Consideración de cualquier DM (I o II) <br/>
&check; Primera fecha de TBC en caso de repetición de TBC <br/>
&check; Eliminados fallecidos a 01/01/2007 (datos agencia y datos e_cap)<br/>
&check; Limpieza de datos, fecha de muerte previa en diagnostics y Events <br/>
&check; Análisis matching matching Cohorte estatíca <br/>
&check; Análisis matching matching Cohorte dinámico con variables dependiendo del tiempo <br/>
&check; Programación dinámica <br/>
&check; Análisis tiempo dependiente cohorte dinámico <br/>
&check; Análisis exploratorio datos agencia <br/>
&check; Generación de 251 variables <br/>
&check; Actualización de datos del Ecap <br/>
&check; Vinculación de tablas E-cap <br/>
&check; Depuración de datos <br/>
&check; Reprogramación y generación de resultados <br/>
&check; Lectura de tablas de históricos de E-Cap proporcionadas por Basic
&check; Agregación en fecha de inclusión (1/2007)
&check; vinculación de tablas en una
&check; Depuración de errores (Eliminación de duplicados, valores negativos.....)
&check; Cálculo de variables
&check; Descriptivo inicial exploratorio
&check; Análisis de asociación de DM versus TBC
&check; Estimación de incidencias

## Pendiente: 

- Depurar base de datos (Corregir errores, definir rango de valores válidos etc...) 
- Etiquetar variables y  valors
- Análisis por objetivos
- Subanálisis

## Consideraciones / limitaciones:

- Solo TBC con fecha disponible
- Excluidos repetidos
- Base de datos vacunas solo disponible a partir de 12/2007 (No en basal)
- Reclasificados expuestos diabeticos en fecha de inclusión (1/2007)
- Possible infraregistro de diagnosticos en 2007
- Alto número de valores faltantes en covariables

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, include=F,size="huge")
#library(epiR)

library(ggplot2)
library(dplyr)
library(survminer)
library(compareGroups)
# CArrego funcions -------------------
link_source<-paste0("https://github.com/jrealgatius/Stat_codis/blob/master/funcions_propies.R","?raw=T")
devtools::source_url(link_source)
conductor_variables<-here::here("variables_tbc.xls")
conductor_agencia<-here::here("conductor_agencia.xls")
if (params$metode=="dinamica2") dir_output<-"dades/output_dinamic2"
if (params$metode=="dinamica") dir_output<-"dades/output_dinamic"
if (params$metode=="estatica") dir_output<-"dades/output"
if (params$metode=="PS") dir_output<-"dades/output_PS"
if (params$test) dir_figures<-"figures/test" else dir_figures<-"figures"
source("funcions_TBC.R")
```


```{r, include=FALSE}
load(here::here(dir_output,"output5.Rdata"))

```


```{r mostreigtest}
if (params$test==T) {
  dt_temp<-dades %>% select(case.id) %>% sample_n(2000)
  dades<-dades %>% semi_join(dt_temp)
    }
```


```{r funcions propies}


Analitica_Temps<-function(
  dt=dt_variables2 ,  
  grup="HBA1c",
  dataini="dat",
  datasort="datafi",
  endpt="situacio",
  bd.dindex="20000101"
  #
  #
) 
{
  
  #dt=dt_variables2 
  #grup="HBA1c"
  #dataini="dat"
  #datasort="datafi"
  #endpt="situacio"
  #bd.dindex=dt_variables2$dtindex  
  
  # sempre la nostra b.d- analitica , ha de tenir: [idp,cod,val], 
  # també, dataInici?,dataSortida?,endPoint?, i dt_index? [qualsevol nom] 
  # sym(!!, treus les ""
  
  #hem posat sexe , s'ha de treure : 26.3.2021!!
  
  dt<-dt%>%select(idp,cod,val,sym(!!dataini),sym(!!datasort),sym(!!endpt))
  dt<-dt%>%arrange(idp,!!dataini)
  
  #
  dataini<-rlang::sym(dataini)
  datasort<-rlang::sym(datasort)
  #
  
  print("Afegint data index en Analitca depenent del Temps")
  dt<-afegir_dataindex(dt,bd.dindex)
  
  dt<-dt%>%filter(cod==!!grup)
  #
  
  
  #################################################################
  #24.3.2021
  dt<-dt%>%filter(!!datasort>=0)
  #################################################################
  
  
  
  #
  print("Posem un NA, aquelles Dates inferiors , al dia Index")
  dt<-dt%>%mutate(dat = ifelse(dat<dtindex , NA, dat ))
  #
  print("Convertim les dates numeriques , amb dates!  ")
  
  dt<-dt%>%mutate(dat2=as.character(!!dataini))
  dt<-dt%>%mutate(dat2=as.Date(dat2,"%Y%m%d"))
  
  dt<-dt%>%mutate(dat_sort=as.character(!!datasort))
  dt<-dt%>%mutate(dat_sort=as.Date(dat_sort,"%Y%m%d"))
  
  #
  #
  #
  print("Calculem el temps!!!")
  dt<-dt%>%dplyr::group_by(idp)%>%mutate(T1=dat2-lag(dat2))%>%ungroup() 
  dt$T1<-as.double(dt$T1)
  dt<-dt%>%mutate(T1 = ifelse(T1==0 | is.na(T1) , 0, T1))
  #
  print("tstart=temps inicial acumulatiu!")
  dt<-dt%>%group_by(idp)%>%mutate(tstart = cumsum(T1))%>%ungroup() 
  #
  print("tstop=temps final acumulatiu!, comptant la data final!")
  dt<-dt%>%group_by(idp)%>%mutate(tstop=lead(tstart))%>%ungroup() 
  
  
  
  dt<-mutate_at(dt, vars( starts_with("tstop") ), funs( if_else(is.na(.)  ,(dat_sort-dat2)+tstart,tstop)))
  #
  print("Base de Dades, preparada, per fer un models amb variables dependents del temps")
  dt<-dt%>%filter(tstop>0)%>%select(-T1,-dat2,-dat_sort)
  
  #################################################################
  #24.3.2021
  
  dt$tstop<-as.numeric(dt$tstop)
  
  #################################################################
  #25.3.2021
  
  dt<-dt%>%mutate(kk=ifelse(idp==lead(idp),0,1))
  dt<-dt%>%mutate(situacio=ifelse(kk==1,situacio,"A"))
  dt<-dt%>%select(-kk)
  
  #
  ##################################################################
  
  #
  dt
}



```




# Tabla 6. Modelos multivariante (variable HbA1c dependiente del tiempo) de los factores que pueden influir en la aparición de una nueva TBC, en una Población Diabetica

```{r, include=F,eval = TRUE}

#############
#[26.3.2021]#
#############

# eps només son diabetics!!!
dades<-dadesDM

# construim una nova base de dades a partir de "dades", per aplicar la FUNCIO ANALITICA.


dades$dtindex2<-as.character(dades$dtindex)
dades$any_index<-substr(dades$dtindex2,1,4)
dades$any_index<-as.numeric(dades$any_index)
dades$any_naix<-as.numeric(dades$any_naix)
dades<-dades%>%mutate(edat=any_index-any_naix)


dades2<-dades%>%select(idp,sexe,edat)

#dades_analitiques_DM<-dades%>%filter(grup=="Diabetis")

dt_variables2<-dt_variables%>%mutate(idp=CIP)%>%select(-CIP)%>%left_join(dades,by="idp")%>%
  select(idp,sexe,dtindex,cod,dat,val,situacio,datafi,EV.TBC)


##############
#[25.03.2021]#
##############

dt_variables2<-dt_variables2%>%filter(!is.na(situacio))

dt_variables2<-dt_variables2%>%mutate(TBC= ifelse(is.na(EV.TBC) , 0, 1))
dt_variables2<-dt_variables2%>%mutate(situacio= ifelse(TBC==1 ,"TBC" , situacio))
dt_variables2$datafi<-ifelse(!is.na(dt_variables2$EV.TBC),dt_variables2$EV.TBC,dt_variables2$datafi)
dt_variables2$datafi<-as.Date(dt_variables2$datafi,origin = "1970-01-01")

#[MIRAR els events de TBC!]
#tranformem les variables de dates a numeriques, perque funcioni la FUNCIO!:

dt_variables2$dat<-as.character(dt_variables2$dat)

dt_variables2$DIA<-substr(dt_variables2$dat,9,10)
dt_variables2$MES<-substr(dt_variables2$dat,6,7)
dt_variables2$ANY<-substr(dt_variables2$dat,1,4)

dt_variables2$dat<-paste0(dt_variables2$ANY,dt_variables2$MES,dt_variables2$DIA)

dt_variables2$dat<-as.numeric(dt_variables2$dat)


dt_variables2$datafi<-as.character(dt_variables2$datafi)

dt_variables2$DIA2<-substr(dt_variables2$datafi,9,10)
dt_variables2$MES2<-substr(dt_variables2$datafi,6,7)
dt_variables2$ANY2<-substr(dt_variables2$datafi,1,4)

dt_variables2$datafi<-paste0(dt_variables2$ANY2,dt_variables2$MES2,dt_variables2$DIA2)

dt_variables2$datafi<-as.numeric(dt_variables2$datafi)
dt_variables2<-dt_variables2%>%select(idp,cod,dat,val,situacio,datafi,dtindex)
dt_variables2<-dt_variables2%>%arrange(cod ,dat)

# mirar la dataIndex??? Demà!!

##################################################################
#FALTA , preguntar Jordi R , pel DTINDEX, +Repàs de la sintaxis! #
##################################################################


# aliquem la funcio

analitiques_temps<-Analitica_Temps(
  dt=dt_variables2 ,  
  grup="HBA1c",
  dataini="dat",
  datasort="datafi",
  endpt="situacio",
  bd.dindex=dt_variables2$dtindex )



# noves recodificacions per fer el posterior Analisi.

analitiques_temps<-analitiques_temps%>%left_join(dades2,by="idp")

analitiques_temps<-analitiques_temps%>%mutate(val_7_5 = ifelse(val<7.5    , 0, 1))
analitiques_temps<-analitiques_temps%>%mutate(val_8 =   ifelse(val<8      , 0, 1))
analitiques_temps<-analitiques_temps%>%mutate(val_9 =   ifelse(val<9      , 0, 1))


analitiques_temps<-analitiques_temps%>%mutate(val2 = ifelse(val<8  , 0, 1))
analitiques_temps<-analitiques_temps%>%mutate(val3 = ifelse(val<9  , 0, 1))

#analitiques_temps
#analitiques_temps$situacio

analitiques_temps<-analitiques_temps %>% mutate(edat_CAT=case_when(edat<75 ~ "1.<75", edat >=75~ "2.>=75" ))






```

```{r MODEL1, include=F,eval = FALSE}

#############
#[26.3.2021]#
#############

#

library(kableExtra)
library(gt)
library(survival)


#i)
#fit1 <- coxph(Surv(tstart, tstop, situacio=="TBC") ~ val+sexe+edat+cluster(idp),data=analitiques_temps)
#summary(fit1)
#cox.zph(fit1)
#plot(cox.zph(fit1))

#############
#[26.3.2021]#
#############

#

#library(kableExtra)
#library(gt)
#library(survival)





#ii)
#fit2 <- coxph(Surv(tstart, tstop, situacio=="TBC") ~ val+edat+cluster(idp), data=analitiques_temps)
#fit2
#cox.zph(fit2)
#plot(cox.zph(fit2))


#############
#[26.3.2021]#
#############

#

#library(kableExtra)
#library(gt)
#library(survival)




#iii)
#fit3 <- coxph(Surv(tstart, tstop, situacio=="TBC") ~ val2+sexe+edat+cluster(idp), data=analitiques_temps)
#fit3
#cox.zph(fit3)
#plot(cox.zph(fit3))

#############
#[26.3.2021]#
#############

#

#library(kableExtra)
#library(gt)
#library(survival)



#iv)
#fit4 <- coxph(Surv(tstart, tstop, situacio=="TBC") ~ val2+edat+cluster(idp), data=analitiques_temps)
#fit4
#cox.zph(fit4)
#plot(cox.zph(fit4))

#############
#[26.3.2021]#
#############

#
#library(kableExtra)
#library(gt)
#library(survival)




#v)
#fit5 <- coxph(Surv(tstart, tstop, situacio=="TBC") ~ val3+sexe+edat+cluster(idp), data=analitiques_temps)
#fit5
#cox.zph(fit5)
#plot(cox.zph(fit5))

#vb)
#fit5 <- coxph(Surv(tstart, tstop, situacio=="TBC") ~ val3+sexe+edat, data=analitiques_temps)
#fit5
#cox.zph(fit5)
#plot(cox.zph(fit5))

#############
#[26.3.2021]#
#############

#

#library(kableExtra)
#library(gt)
#library(survival)



#vi)
#fit6 <- coxph(Surv(tstart, tstop, situacio=="TBC") ~ val3+edat+cluster(idp), data=analitiques_temps)
#fit6
#cox.zph(fit6)
#plot(cox.zph(fit6))
#############
#[30.3.2021]#
#############

#

#library(kableExtra)
#library(gt)
#library(survival)



#vii) val2+sexe+edat_CAT+cluster(idp)
#fit7 <- coxph(Surv(tstart, tstop, situacio=="TBC") ~ val2+sexe+edat_CAT+cluster(idp), data=analitiques_temps)
#fit7
#cox.zph(fit7)
#plot(cox.zph(fit7))

#viii) val2+sexe+cluster(idp)
#fit8 <- coxph(Surv(tstart, tstop, situacio=="TBC") ~ val2+sexe+cluster(idp), data=analitiques_temps)
#fit8
#cox.zph(fit8)
#plot(cox.zph(fit8))

#xi) val2+edat_CAT+cluster(idp)
#fit9 <- coxph(Surv(tstart, tstop, situacio=="TBC") ~ val2+edat_CAT+cluster(idp), data=analitiques_temps)
#fit9
#cox.zph(fit9)
#plot(cox.zph(fit9))


#x) val3+sexe+edat_CAT+cluster(idp)
#fit10 <- coxph(Surv(tstart, tstop, situacio=="TBC") ~ val3+sexe+edat_CAT+cluster(idp), data=analitiques_temps)
#fit10
#cox.zph(fit10)
#plot(cox.zph(fit10))

#xi)val3+sexe+cluster(idp)
#fit11 <- coxph(Surv(tstart, tstop, situacio=="TBC") ~ val3+sexe+cluster(idp), data=analitiques_temps)
#fit11
#cox.zph(fit11)
#plot(cox.zph(fit11))

#xii) val3+edat_CAT+cluster(idp)
#fit12 <- coxph(Surv(tstart, tstop, situacio=="TBC") ~ val3+edat_CAT+cluster(idp), data=analitiques_temps)
#fit12
#cox.zph(fit12)
#plot(cox.zph(fit12))



```

```{r MODEL8, include=F,eval = F}

#############
#[30.3.2021]#
#############

# 17:58!

#library(kableExtra)
#library(gt)
#library(survival)

# the finish: https://cran.r-project.org/web/packages/survival/vignettes/timedep.pdf
# https://web.njit.edu/~wguo/Math%20659_2010/Chapters%205%20and%206%20%20from%20%5BSurvival%20Analysis_A%20Self%20Learning%20Text_Book%5D.pdf

#xiii)
#fit13 <- coxph(Surv(tstart, tstop, situacio=="TBC") ~ val3+edat_CAT+cluster(idp)+strata(sexe), data=analitiques_temps)
#fit13
#cox.zph(fit13)
#plot(cox.zph(fit13))

#analitiques_temps<-analitiques_temps %>% mutate(sex2=case_when(sexe=="Female" ~ 0,sexe=="Male" ~ 1))


#fit14 <- coxph(Surv(tstart, tstop, situacio=="TBC") ~ val3+edat_CAT+cluster(idp)+strata(sex2), data=analitiques_temps)
#fit14
#cox.zph(fit14)
#plot(cox.zph(fit14))



#plot(survfit(fit14),ylim=c(0.5,1),lty=0:1)


```

## Tabla.6a Modelos de Cox dependientes del Tiempo (HBA1c) para la TBC,estratificado por sexo.[Hba1c>7.5+strata(Sexe)+Edat+cluster(idp]

```{r MODEL_COX1, include=T,eval = TRUE}

#############
#[25.3.2022]#
#############



library(kableExtra)
library(gt)
library(survival)

# Ara fem els MODELS!:[]

#analitiques_temps<-analitiques_temps%>%mutate(val_7_5 = ifelse(val<7.5    , 0, 1))
#analitiques_temps<-analitiques_temps%>%mutate(val_8 =   ifelse(val<8      , 0, 1))
#analitiques_temps<-analitiques_temps%>%mutate(val_9 =   ifelse(val<9      , 0, 1))



#i)
#fit1 <- coxph(Surv(tstart, tstop, situacio=="TBC") ~ val_7_5+sexe+edat+cluster(idp),data=analitiques_temps)
#summary(fit1)
#cox.zph(fit1)
#plot(cox.zph(fit1))

fit1b <- coxph(Surv(tstart, tstop, situacio=="TBC") ~ val_7_5+edat+strata(sexe)+cluster(idp),data=analitiques_temps)
summary(fit1b)
cox.zph(fit1b)

```

## Tabla.6b Modelos de Cox dependientes del Tiempo (HBA1c) para la TBC,estratificado por sexo.[Hba1c>8+strata(Sexe)+Edat+cluster(idp]

```{r MODEL_COX2, include=T,eval = TRUE}

#ii)
#fit2 <- coxph(Surv(tstart, tstop, situacio=="TBC") ~ val_8+sexe+edat+cluster(idp),data=analitiques_temps)
#summary(fit2)
#cox.zph(fit2)

fit2b <- coxph(Surv(tstart, tstop, situacio=="TBC") ~ val_8+edat+strata(sexe)+cluster(idp),data=analitiques_temps)
summary(fit2b)
cox.zph(fit2b)


```

## Tabla.6c Modelos de Cox dependientes del Tiempo (HBA1c) para la TBC,estratificado por sexo.[Hba1c>9+strata(Sexe)+Edat+cluster(idp]

```{r MODEL_COX3, include=T,eval = TRUE}

#iii)
#fit3 <- coxph(Surv(tstart, tstop, situacio=="TBC") ~ val_9+sexe+edat+cluster(idp),data=analitiques_temps)
#summary(fit3)
#cox.zph(fit3)

#iv)
fit4 <- coxph(Surv(tstart, tstop, situacio=="TBC") ~ val_9+edat+strata(sexe)+cluster(idp),data=analitiques_temps)
summary(fit4)
cox.zph(fit4)


plot(cox.zph(fit4))


```






&nbsp;
<hr />
  <p style="text-align: center;">A work by $Jordi Real$ </a></p>
  <p style="text-align: center;">$Llepali-System$ </a></p>
  <p style="text-align: center;"><span style="color: #808080;"><em><https://github.com/USR-DAPCAT/></em></span></p>
  
  